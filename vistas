/* ============================================================
   VISTA 1: v_ParqueoEditableSimple
   autor: David Martínez
   propósito: Mostrar los parqueos junto con datos básicos
   de tarjeta, sede y vehículo, y permitir insertar/actualizar
   parqueos directamente desde la vista.
   Tablas base: parqueo (editable), Tarjeta, sede, vehiculo
   ============================================================ */

CREATE OR ALTER VIEW dbo.v_ParqueoEditableSimple
AS
SELECT
    
    p.id_parqueo,           
    p.id_tarjeta,           -- FK a la tarjeta usada para ingresar
    p.id_sede,              -- FK a la sede donde ocurre el parqueo
    p.placa_vehiculo,       -- FK al vehículo que se parqueó
    p.fecha_hora_ingreso,   -- hora de entrada
    p.fecha_hora_salida,    -- hora de salida
    p.estado_parqueo,       -- estado actual del parqueo (Abierto/Cerrado)

    
    s.nombre_sede,          -- nombre de la sede
    t.estado_tarjeta,       -- estado de la tarjeta usada
    v.marca,                -- marca del vehículo
    v.modelo,               -- modelo del vehículo
    v.color                 -- color del vehículo
FROM parqueo  AS p
JOIN Tarjeta  AS t ON t.id_tarjeta = p.id_tarjeta
JOIN sede     AS s ON s.id_sede    = p.id_sede
JOIN vehiculo AS v ON v.placa      = p.placa_vehiculo;
GO

/* ============================================================
   TRIGGER: tr_v_ParqueoEditableSimple_INS
   propósito: Cuando el usuario hace un INSERT sobre la vista,
   este trigger redirige el insert a la tabla base PARQUEO.
   ============================================================ */

CREATE OR ALTER TRIGGER dbo.tr_v_ParqueoEditableSimple_INS
ON dbo.v_ParqueoEditableSimple
INSTEAD OF INSERT
AS
BEGIN
    SET NOCOUNT ON;  -- evita mensajes extra de "x filas afectadas"

    INSERT INTO parqueo
        (id_tarjeta, fecha_hora_ingreso, fecha_hora_salida, id_sede, placa_vehiculo, estado_parqueo)
    SELECT
        i.id_tarjeta,                            -- usa la tarjeta que viene en el insert
        ISNULL(i.fecha_hora_ingreso, GETDATE()), -- si no se envía una fecha, usa la actual
        NULL,                                    -- la salida se deja nula al abrir el parqueo
        i.id_sede,                               -- sede del parqueo
        i.placa_vehiculo,                        -- vehículo que ingresa
        'Abierto'                                -- nuevo parqueo siempre inicia en estado Abierto
    FROM inserted AS i;                          -- 'inserted' es la tabla temporal con los datos nuevos
END;
GO
/* ============================================================
   TRIGGER: tr_v_ParqueoEditableSimple_UPD
   propósito: Cuando el usuario hace un UPDATE sobre la vista,
   este trigger redirige la modificación a la tabla base PARQUEO.
   ============================================================ */

CREATE OR ALTER TRIGGER dbo.tr_v_ParqueoEditableSimple_UPD
ON dbo.v_ParqueoEditableSimple
INSTEAD OF UPDATE
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE p
    SET
        -- Si el usuario mandó un nuevo id_tarjeta, se usa ese;
        -- si no, se mantiene el valor anterior.
        p.id_tarjeta =
            CASE 
                WHEN i.id_tarjeta IS NOT NULL THEN i.id_tarjeta
                ELSE p.id_tarjeta
            END,

        -- Misma lógica para id_sede
        p.id_sede =
            CASE 
                WHEN i.id_sede IS NOT NULL THEN i.id_sede
                ELSE p.id_sede
            END,

        -- Y también para la placa del vehículo
        p.placa_vehiculo =
            CASE 
                WHEN i.placa_vehiculo IS NOT NULL THEN i.placa_vehiculo
                ELSE p.placa_vehiculo
            END,

        -- Si se envía una nueva fecha de ingreso, la actualiza;
        -- si no, conserva la anterior.
        p.fecha_hora_ingreso =
            CASE 
                WHEN i.fecha_hora_ingreso IS NOT NULL THEN i.fecha_hora_ingreso
                ELSE p.fecha_hora_ingreso
            END,

        -- Igual con la fecha de salida.
        p.fecha_hora_salida =
            CASE 
                WHEN i.fecha_hora_salida IS NOT NULL THEN i.fecha_hora_salida
                ELSE p.fecha_hora_salida
            END,

        -- Aquí se aplica la lógica del estado:
        -- Si hay una fecha de salida (no es NULL) → estado = 'Cerrado'
        -- Si NO hay fecha de salida → estado = 'Abierto'
        p.estado_parqueo =
            CASE
                WHEN (CASE 
                        WHEN i.fecha_hora_salida IS NOT NULL THEN i.fecha_hora_salida
                        ELSE p.fecha_hora_salida
                      END) IS NOT NULL
                THEN 'Cerrado'
                ELSE 'Abierto'
            END
    FROM parqueo p
    JOIN inserted i ON i.id_parqueo = p.id_parqueo;  -- se actualizan solo los registros que se están modificando
END;
GO

/* ============================================================
   VISTA 2: v_FacturaEditableSimple
   autor: David Martínez
   propósito: Permitir crear o modificar facturas de lavados
   y mostrar datos de cliente, sede y lavado asociados.
   Tablas base: factura (editable), cliente, sede, liquidacion_lavado, lavado
   ============================================================ */

CREATE OR ALTER VIEW dbo.v_FacturaEditableSimple
AS
SELECT
    -- Campos EDITABLES (de la tabla FACTURA)
    f.id_factura,           -- PK de la factura
    f.fecha_emision,        -- fecha de emisión de la factura
    f.documento_cliente,    -- cliente asociado
    f.id_sede,              -- sede donde se genera la factura
    f.total_pagar,          -- total a cobrar
    f.id_liquidacion_lavado,-- FK a la liquidación del lavado

    -- Campos informativos (de otras tablas)
    c.nombre       AS nombre_cliente,
    s.nombre_sede,
    lv.id_lavado,
    lv.precio_lavado
FROM factura f
JOIN cliente c             ON c.documento              = f.documento_cliente
JOIN sede s                ON s.id_sede                = f.id_sede
JOIN liquidacion_lavado lq ON lq.id_liquidacion_lavado = f.id_liquidacion_lavado
JOIN lavado lv             ON lv.id_lavado             = lq.id_lavado;
GO
/* ============================================================
   TRIGGER: tr_v_FacturaEditableSimple_INS
   propósito: Cuando se hace INSERT sobre la vista,
   inserta los datos en la tabla base FACTURA.
   ============================================================ */

CREATE OR ALTER TRIGGER dbo.tr_v_FacturaEditableSimple_INS
ON dbo.v_FacturaEditableSimple
INSTEAD OF INSERT
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO factura
        (fecha_emision, documento_cliente, id_sede, total_pagar, id_liquidacion_lavado)
    SELECT
        -- Si el usuario manda una fecha, se usa;
        -- si no, se usa la fecha actual del sistema.
        CASE 
            WHEN i.fecha_emision IS NOT NULL THEN i.fecha_emision
            ELSE CAST(GETDATE() AS DATE)
        END,

        -- Cliente, sede y liquidación se insertan directamente desde lo que venga en la vista.
        i.documento_cliente,
        i.id_sede,

        -- Si el usuario no envía el total, se guarda 0 para evitar NULL.
        CASE 
            WHEN i.total_pagar IS NOT NULL THEN i.total_pagar
            ELSE 0
        END,

        i.id_liquidacion_lavado
    FROM inserted AS i;
END;
GO
/* ============================================================
   TRIGGER: tr_v_FacturaEditableSimple_UPD
   propósito: Permite actualizar campos de factura desde la vista.
   ============================================================ */

CREATE OR ALTER TRIGGER dbo.tr_v_FacturaEditableSimple_UPD
ON dbo.v_FacturaEditableSimple
INSTEAD OF UPDATE
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE f
    SET
        -- Si se envía una nueva fecha de emisión, la actualiza;
        -- si no, conserva la anterior.
        f.fecha_emision =
            CASE 
                WHEN i.fecha_emision IS NOT NULL THEN i.fecha_emision
                ELSE f.fecha_emision
            END,

        -- Si se envía un nuevo total, se actualiza;
        -- de lo contrario, permanece igual.
        f.total_pagar =
            CASE 
                WHEN i.total_pagar IS NOT NULL THEN i.total_pagar
                ELSE f.total_pagar
            END,

        -- Si se cambia la sede, se actualiza.
        f.id_sede =
            CASE 
                WHEN i.id_sede IS NOT NULL THEN i.id_sede
                ELSE f.id_sede
            END,

        -- Actualiza el cliente si se envía un nuevo documento.
        f.documento_cliente =
            CASE 
                WHEN i.documento_cliente IS NOT NULL THEN i.documento_cliente
                ELSE f.documento_cliente
            END,

        -- Si se envía un nuevo id_liquidacion_lavado, se usa ese.
        f.id_liquidacion_lavado =
            CASE 
                WHEN i.id_liquidacion_lavado IS NOT NULL THEN i.id_liquidacion_lavado
                ELSE f.id_liquidacion_lavado
            END
    FROM factura f
    JOIN inserted i ON i.id_factura = f.id_factura;
END;
GO
